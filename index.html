<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC屏幕共享（稳定版）</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .role-select {
            text-align: center;
            margin-bottom: 20px;
        }
        .role-btn {
            padding: 10px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            background-color: #007bff;
            color: white;
        }
        .role-btn.active {
            background-color: #0056b3;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #startShare {
            background-color: #28a745;
            color: white;
            display: none;
        }
        #startShare:hover {
            background-color: #218838;
        }
        #stopShare {
            background-color: #dc3545;
            color: white;
            display: none;
        }
        #stopShare:hover {
            background-color: #c82333;
        }
        .screen-container {
            width: 100%;
            height: 600px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #fafafa;
        }
        #screenPreview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .placeholder {
            color: #999;
            text-align: center;
            padding: 20px;
        }
        .status {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC屏幕共享（稳定版）</h1>
        <div class="role-select">
            <button class="role-btn" id="broadcasterBtn">我是共享者</button>
            <button class="role-btn" id="viewerBtn">我是观看者</button>
        </div>
        <div class="btn-group">
            <button id="startShare">开始共享屏幕</button>
            <button id="stopShare">停止共享</button>
        </div>
        <div class="screen-container">
            <video id="screenPreview" autoplay muted playsinline></video>
            <div class="placeholder" id="placeholder">
                <p>请先选择角色：</p>
                <p>「我是共享者」- 启动屏幕共享 | 「我是观看者」- 查看他人共享</p>
            </div>
        </div>
        <div class="status" id="status">状态：未选择角色</div>
    </div>

    <script>
        // DOM元素
        const broadcasterBtn = document.getElementById('broadcasterBtn');
        const viewerBtn = document.getElementById('viewerBtn');
        const startShareBtn = document.getElementById('startShare');
        const stopShareBtn = document.getElementById('stopShare');
        const screenPreview = document.getElementById('screenPreview');
        const placeholder = document.getElementById('placeholder');
        const statusText = document.getElementById('status');

        // WebRTC核心变量
        let isBroadcaster = false; // 是否为共享者
        let screenStream = null;   // 屏幕流
        let peerConnection = null; // WebRTC连接
        let signalingChannel = null; // 信令通道
        const roomId = 'my-screen-share-123'; // 固定房间ID

        // 1. 角色选择
        broadcasterBtn.addEventListener('click', () => {
            isBroadcaster = true;
            broadcasterBtn.classList.add('active');
            viewerBtn.classList.remove('active');
            startShareBtn.style.display = 'inline-block';
            placeholder.innerHTML = '<p>点击「开始共享屏幕」，选择要共享的内容</p>';
            statusText.textContent = '状态：已选择「共享者」角色';
            statusText.style.color = '#666';
            // 初始化信令通道
            initSignalingChannel();
        });

        viewerBtn.addEventListener('click', () => {
            isBroadcaster = false;
            viewerBtn.classList.add('active');
            broadcasterBtn.classList.remove('active');
            startShareBtn.style.display = 'none';
            placeholder.innerHTML = '<p>等待共享者启动屏幕共享...</p>';
            statusText.textContent = '状态：已选择「观看者」角色，等待共享流';
            statusText.style.color = '#666';
            // 初始化信令通道和观看者
            initSignalingChannel();
            initViewer();
        });

        // 2. 初始化稳定的信令通道（改用WebRTC直接交换，无外部服务器依赖）
        function initSignalingChannel() {
            // 存储信令消息（用于手动交换，适合少量用户测试）
            window.signalingMessages = window.signalingMessages || [];
            
            statusText.textContent = `${statusText.textContent} | 信令通道已初始化`;
        }

        // 3. 共享者：启动屏幕共享
        startShareBtn.addEventListener('click', async () => {
            if (!isBroadcaster) return;

            try {
                // 捕获屏幕流
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: 'always', width: { ideal: 1920 }, height: { ideal: 1080 } },
                    audio: false
                });

                // 本地预览
                screenPreview.srcObject = screenStream;
                screenPreview.style.display = 'block';
                placeholder.style.display = 'none';

                // 更新UI
                startShareBtn.style.display = 'none';
                stopShareBtn.style.display = 'inline-block';
                statusText.textContent = '状态：正在共享屏幕，等待观看者连接（请让观看者刷新页面）';
                statusText.style.color = '#28a745';

                // 初始化共享者的WebRTC连接
                initBroadcaster();

                // 监听流结束
                screenStream.getVideoTracks()[0].addEventListener('ended', stopShare);

            } catch (error) {
                console.error('屏幕捕获失败：', error);
                statusText.textContent = `状态：共享失败 - ${error.message}`;
                statusText.style.color = '#dc3545';
            }
        });

        // 4. 停止共享
        stopShareBtn.addEventListener('click', stopShare);

        // 5. 初始化共享者（广播端）
        function initBroadcaster() {
            // 创建WebRTC连接
            createPeerConnection();

            // 添加屏幕流到连接
            screenStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, screenStream);
            });

            // 监听ICE候选，存储到全局（用于交换）
            peerConnection.addEventListener('icecandidate', (e) => {
                if (e.candidate) {
                    window.signalingMessages.push({
                        type: 'candidate',
                        candidate: e.candidate,
                        roomId: roomId
                    });
                    // 提示共享者复制候选（手动交换备用）
                    statusText.textContent = '状态：生成连接候选，请让观看者刷新页面接收';
                }
            });

            // 创建Offer（广播端主动发起）
            peerConnection.createOffer({
                offerToReceiveVideo: false,
                offerToReceiveAudio: false
            })
            .then(offer => peerConnection.setLocalDescription(offer))
            .then(() => {
                // 存储Offer到全局
                window.signalingMessages.push({
                    type: 'offer',
                    offer: peerConnection.localDescription,
                    roomId: roomId
                });
                // 自动触发观看者的Offer接收（简化版）
                if (window.onOfferReceived) {
                    window.onOfferReceived(peerConnection.localDescription);
                }
            });
        }

        // 6. 初始化观看者（接收端）
        function initViewer() {
            createPeerConnection();

            // 监听远程流（共享者的屏幕流）
            peerConnection.addEventListener('track', (e) => {
                screenPreview.srcObject = e.streams[0];
                screenPreview.style.display = 'block';
                placeholder.style.display = 'none';
                statusText.textContent = '状态：已连接到共享者，正在观看屏幕';
                statusText.style.color = '#28a745';
            });

            // 监听ICE候选
            peerConnection.addEventListener('icecandidate', (e) => {
                if (e.candidate) {
                    window.signalingMessages.push({
                        type: 'candidate',
                        candidate: e.candidate,
                        roomId: roomId
                    });
                }
            });

            // 注册Offer接收回调
            window.onOfferReceived = (offer) => {
                peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        // 存储Answer到全局
                        window.signalingMessages.push({
                            type: 'answer',
                            answer: peerConnection.localDescription,
                            roomId: roomId
                        });
                        // 自动触发共享者的Answer接收
                        if (window.onAnswerReceived) {
                            window.onAnswerReceived(peerConnection.localDescription);
                        }
                    });
            };

            // 检查已有Offer（共享者已先发的情况）
            const existingOffer = window.signalingMessages.find(msg => msg.type === 'offer' && msg.roomId === roomId);
            if (existingOffer) {
                window.onOfferReceived(existingOffer.offer);
            }
        }

        // 7. 共享者接收Answer的回调
        window.onAnswerReceived = (answer) => {
            if (isBroadcaster && peerConnection) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                statusText.textContent = '状态：观看者已连接，屏幕共享中';
                // 添加所有ICE候选
                window.signalingMessages.forEach(msg => {
                    if (msg.type === 'candidate' && msg.roomId === roomId) {
                        peerConnection.addIceCandidate(new RTCIceCandidate(msg.candidate))
                            .catch(err => console.warn('添加ICE候选失败：', err));
                    }
                });
            }
        };

        // 8. 创建WebRTC连接（使用谷歌免费STUN服务器）
        function createPeerConnection() {
            // ICE服务器（稳定的谷歌STUN服务器）
            const iceServers = [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ];

            // 创建PeerConnection
            peerConnection = new RTCPeerConnection({ 
                iceServers: iceServers,
                iceTransportPolicy: 'all'
            });

            // 监听连接状态
            peerConnection.addEventListener('connectionstatechange', () => {
                console.log('连接状态：', peerConnection.connectionState);
                if (peerConnection.connectionState === 'connected') {
                    if (isBroadcaster) {
                        statusText.textContent = '状态：观看者已连接，屏幕共享中';
                    } else {
                        statusText.textContent = '状态：已成功连接，正在观看屏幕';
                    }
                } else if (peerConnection.connectionState === 'failed') {
                    statusText.textContent = '状态：连接失败，请刷新页面重试';
                    statusText.style.color = '#dc3545';
                }
            });
        }

        // 9. 停止共享核心函数
        function stopShare() {
            // 停止屏幕流
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // 关闭WebRTC连接
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // 清空信令消息
            window.signalingMessages = [];

            // 重置UI
            screenPreview.srcObject = null;
            screenPreview.style.display = 'none';
            placeholder.style.display = 'block';
            startShareBtn.style.display = 'inline-block';
            stopShareBtn.style.display = 'none';

            if (isBroadcaster) {
                statusText.textContent = '状态：已停止屏幕共享';
                placeholder.innerHTML = '<p>点击「开始共享屏幕」，选择要共享的内容</p>';
            } else {
                statusText.textContent = '状态：共享已停止，等待共享者重新启动';
                placeholder.innerHTML = '<p>等待共享者启动屏幕共享...</p>';
            }
            statusText.style.color = '#666';
        }

        // 10. 页面关闭时清理
        window.addEventListener('beforeunload', () => {
            stopShare();
        });
    </script>
</body>
</html>
