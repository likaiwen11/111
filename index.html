<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仅屏幕共享（无音频）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", Arial; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .btn-group { text-align: center; margin-bottom: 20px; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.3s;
        }
        #startBtn { background: #28a745; color: white; }
        #startBtn:hover { background: #218838; }
        #stopBtn { background: #dc3545; color: white; display: none; }
        #stopBtn:hover { background: #c82333; }
        .screen-box {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .tips { color: #999; text-align: center; font-size: 18px; }
        .status { text-align: center; margin-top: 15px; color: #666; font-size: 14px; }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
    </style>
    <!-- 改用jsdelivr稳定镜像（仅加载视频相关SDK） -->
    <script src="https://cdn.jsdelivr.net/npm/agora-rtc-sdk@3.6.12/build/AgoraRTCSDK.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>仅屏幕共享（无音频）</h1>
        <div class="btn-group">
            <button id="startBtn">开始共享屏幕</button>
            <button id="stopBtn">停止共享</button>
        </div>
        <div class="screen-box">
            <video id="remoteVideo" autoplay playsinline muted></video>
            <div class="tips" id="tips">等待共享者启动屏幕共享...</div>
        </div>
        <div class="status" id="status">状态：未开始共享</div>
    </div>

    <script>
        // ========== 配置（已替换为你的App ID） ==========
        const AGORA_APP_ID = "05af0374750f4dddab5790c48f05be63"; 
        const CHANNEL_NAME = "screen-share-001";
        
        // ========== DOM元素 ==========
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const remoteVideo = document.getElementById('remoteVideo');
        const tips = document.getElementById('tips');
        const status = document.getElementById('status');
        
        // ========== 核心变量 ==========
        let client = null;       // 3.x版本客户端实例
        let screenStream = null; // 屏幕流（仅视频）
        let isSharing = false;   // 是否正在共享

        // ========== 初始化Agora客户端（仅视频） ==========
        async function initAgoraClient() {
            try {
                // 检查SDK是否加载成功
                if (typeof AgoraRTC === 'undefined') {
                    // 尝试动态加载SDK
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/agora-rtc-sdk@3.6.12/build/AgoraRTCSDK.min.js';
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    // 再次检查
                    if (typeof AgoraRTC === 'undefined') {
                        throw new Error("SDK加载失败，请检查网络或手动下载SDK到本地");
                    }
                }

                // 初始化客户端（仅视频模式）
                client = AgoraRTC.createClient({ 
                    mode: "rtc", 
                    codec: "h264",
                    role: "audience" // 仅观众模式（避免音频权限请求）
                });
                
                // 仅监听视频流相关事件
                client.on("user-published", async (user, mediaType) => {
                    // 只处理视频流，忽略音频
                    if (mediaType !== "video") return;
                    
                    // 订阅远程视频流
                    await client.subscribe(user, "video");
                    
                    // 显示屏幕共享画面（无音频）
                    remoteVideo.srcObject = user.videoStream;
                    remoteVideo.style.display = "block";
                    tips.style.display = "none";
                    status.textContent = "状态：正在观看屏幕共享（无音频）";
                    status.className = "status success";
                });

                // 监听视频流取消发布
                client.on("user-unpublished", (user) => {
                    if (user.videoStream) {
                        remoteVideo.srcObject = null;
                        remoteVideo.style.display = "none";
                        tips.style.display = "block";
                        tips.textContent = "共享者已停止共享，等待重新开始...";
                        status.textContent = "状态：共享已停止";
                        status.className = "status";
                    }
                });

                // 加入频道（仅视频）
                const uid = await client.join(AGORA_APP_ID, CHANNEL_NAME, null, Math.floor(Math.random() * 1000000));
                
                status.textContent = "状态：已连接到频道，等待屏幕共享（无音频）";
                return true;

            } catch (error) {
                console.error("初始化失败：", error);
                status.textContent = `状态：初始化失败 - ${error.message}`;
                status.className = "status error";
                return false;
            }
        }

        // ========== 开始屏幕共享（仅视频，无音频） ==========
        async function startScreenShare() {
            try {
                startBtn.disabled = true;
                status.textContent = "状态：正在请求屏幕共享权限（仅视频）...";

                // 创建纯屏幕视频流（禁用音频）
                screenStream = await AgoraRTC.createScreenStream({
                    encoderConfig: "1080p_1", // 1080P 30帧
                    cursor: true,             // 显示鼠标
                    audio: false              // 明确禁用音频
                });

                // 初始化视频流
                await screenStream.init();

                // 监听屏幕流结束
                screenStream.on("stop", () => {
                    stopScreenShare();
                    status.textContent = "状态：屏幕共享被手动终止";
                });

                // 发布仅视频流
                await client.publish(screenStream, "video");

                // 本地预览（静音）
                remoteVideo.srcObject = screenStream.stream;
                remoteVideo.muted = true; // 强制静音
                remoteVideo.style.display = "block";
                tips.style.display = "none";

                // 更新UI
                isSharing = true;
                startBtn.style.display = "none";
                stopBtn.style.display = "inline-block";
                status.textContent = "状态：屏幕共享中（无音频），其他设备可观看";
                status.className = "status success";
                startBtn.disabled = false;

            } catch (error) {
                console.error("共享启动失败：", error);
                status.textContent = `状态：共享失败 - ${error.message}`;
                status.className = "status error";
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                startBtn.disabled = false;
            }
        }

        // ========== 停止屏幕共享 ==========
        async function stopScreenShare() {
            try {
                if (!isSharing) return;

                // 停止并销毁仅视频流
                if (screenStream) {
                    screenStream.stop();
                    await client.unpublish(screenStream, "video");
                    screenStream = null;
                }

                // 更新UI
                isSharing = false;
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                remoteVideo.srcObject = null;
                remoteVideo.style.display = "none";
                tips.style.display = "block";
                tips.textContent = "等待共享者启动屏幕共享...";
                status.textContent = "状态：已停止共享（无音频）";
                status.className = "status";

            } catch (error) {
                console.error("停止共享失败：", error);
                status.textContent = `状态：停止失败 - ${error.message}`;
                status.className = "status error";
            }
        }

        // ========== 页面初始化 ==========
        window.addEventListener("DOMContentLoaded", async () => {
            // 初始化客户端
            const initSuccess = await initAgoraClient();
            if (initSuccess) {
                startBtn.addEventListener("click", startScreenShare);
                stopBtn.addEventListener("click", stopScreenShare);
            }
        });

        // ========== 页面关闭清理（仅视频资源） ==========
        window.addEventListener("beforeunload", async () => {
            if (isSharing) await stopScreenShare();
            if (client) await client.leave();
        });
    </script>
</body>
</html>
