<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC屏幕共享</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        body {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        .role-select {
            text-align: center;
            margin-bottom: 20px;
        }
        .role-btn {
            padding: 10px 25px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            background-color: #007bff;
            color: white;
        }
        .role-btn.active {
            background-color: #0056b3;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #startShare {
            background-color: #28a745;
            color: white;
            display: none;
        }
        #startShare:hover {
            background-color: #218838;
        }
        #stopShare {
            background-color: #dc3545;
            color: white;
            display: none;
        }
        #stopShare:hover {
            background-color: #c82333;
        }
        .screen-container {
            width: 100%;
            height: 600px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-color: #fafafa;
        }
        #screenPreview {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .placeholder {
            color: #999;
            text-align: center;
            padding: 20px;
        }
        .status {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>WebRTC屏幕共享</h1>
        <div class="role-select">
            <button class="role-btn" id="broadcasterBtn">我是共享者</button>
            <button class="role-btn" id="viewerBtn">我是观看者</button>
        </div>
        <div class="btn-group">
            <button id="startShare">开始共享屏幕</button>
            <button id="stopShare">停止共享</button>
        </div>
        <div class="screen-container">
            <video id="screenPreview" autoplay muted playsinline></video>
            <div class="placeholder" id="placeholder">
                <p>请先选择角色：</p>
                <p>「我是共享者」- 启动屏幕共享 | 「我是观看者」- 查看他人共享</p>
            </div>
        </div>
        <div class="status" id="status">状态：未选择角色</div>
    </div>

    <script>
        // DOM元素
        const broadcasterBtn = document.getElementById('broadcasterBtn');
        const viewerBtn = document.getElementById('viewerBtn');
        const startShareBtn = document.getElementById('startShare');
        const stopShareBtn = document.getElementById('stopShare');
        const screenPreview = document.getElementById('screenPreview');
        const placeholder = document.getElementById('placeholder');
        const statusText = document.getElementById('status');

        // WebRTC核心变量
        let isBroadcaster = false; // 是否为共享者
        let screenStream = null;   // 屏幕流
        let peerConnection = null; // WebRTC连接
        let roomId = 'screen-share-room'; // 房间ID（固定，确保所有人进同一个房间）

        // 公共信令服务器（免费测试用，生产环境需自己搭建）
        const socket = new WebSocket(`wss://socketsbay.com/wss/v2/1/demo/${roomId}/`);

        // 1. 角色选择
        broadcasterBtn.addEventListener('click', () => {
            isBroadcaster = true;
            broadcasterBtn.classList.add('active');
            viewerBtn.classList.remove('active');
            startShareBtn.style.display = 'inline-block';
            placeholder.innerHTML = '<p>点击「开始共享屏幕」，选择要共享的内容</p>';
            statusText.textContent = '状态：已选择「共享者」角色';
            statusText.style.color = '#666';
        });

        viewerBtn.addEventListener('click', () => {
            isBroadcaster = false;
            viewerBtn.classList.add('active');
            broadcasterBtn.classList.remove('active');
            startShareBtn.style.display = 'none';
            placeholder.innerHTML = '<p>等待共享者启动屏幕共享...</p>';
            statusText.textContent = '状态：已选择「观看者」角色，等待共享流';
            statusText.style.color = '#666';
            initViewer(); // 初始化观看者
        });

        // 2. 共享者：启动屏幕共享
        startShareBtn.addEventListener('click', async () => {
            if (!isBroadcaster) return;

            try {
                // 捕获屏幕流
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: 'always' },
                    audio: false
                });

                // 本地预览
                screenPreview.srcObject = screenStream;
                screenPreview.style.display = 'block';
                placeholder.style.display = 'none';

                // 更新UI
                startShareBtn.style.display = 'none';
                stopShareBtn.style.display = 'inline-block';
                statusText.textContent = '状态：正在共享屏幕，等待观看者连接';
                statusText.style.color = '#28a745';

                // 初始化共享者的WebRTC连接
                initBroadcaster();

                // 监听流结束
                screenStream.getVideoTracks()[0].addEventListener('ended', stopShare);

            } catch (error) {
                console.error('屏幕捕获失败：', error);
                statusText.textContent = `状态：共享失败 - ${error.message}`;
                statusText.style.color = '#dc3545';
            }
        });

        // 3. 停止共享
        stopShareBtn.addEventListener('click', stopShare);

        // 4. 初始化共享者（广播端）
        function initBroadcaster() {
            // 创建WebRTC连接
            createPeerConnection();

            // 添加屏幕流到连接
            screenStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, screenStream);
            });

            // 监听ICE候选，发送给信令服务器
            peerConnection.addEventListener('icecandidate', (e) => {
                if (e.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        candidate: e.candidate,
                        roomId: roomId
                    }));
                }
            });

            // 创建Offer（广播端主动发起）
            peerConnection.createOffer()
                .then(offer => peerConnection.setLocalDescription(offer))
                .then(() => {
                    // 发送Offer到信令服务器
                    socket.send(JSON.stringify({
                        type: 'offer',
                        offer: peerConnection.localDescription,
                        roomId: roomId
                    }));
                });
        }

        // 5. 初始化观看者（接收端）
        function initViewer() {
            createPeerConnection();

            // 监听远程流（共享者的屏幕流）
            peerConnection.addEventListener('track', (e) => {
                screenPreview.srcObject = e.streams[0];
                screenPreview.style.display = 'block';
                placeholder.style.display = 'none';
                statusText.textContent = '状态：已连接到共享者，正在观看屏幕';
                statusText.style.color = '#28a745';
            });

            // 监听ICE候选
            peerConnection.addEventListener('icecandidate', (e) => {
                if (e.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        candidate: e.candidate,
                        roomId: roomId
                    }));
                }
            });
        }

        // 6. 创建WebRTC连接
        function createPeerConnection() {
            // ICE服务器（免费公共服务器，用于NAT穿透）
            const iceServers = [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ];

            // 创建PeerConnection
            peerConnection = new RTCPeerConnection({ iceServers });
        }

        // 7. 信令服务器消息处理
        socket.addEventListener('message', (e) => {
            const message = JSON.parse(e.data);
            if (message.roomId !== roomId) return;

            // 观看者接收Offer
            if (message.type === 'offer' && !isBroadcaster) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(message.offer))
                    .then(() => peerConnection.createAnswer())
                    .then(answer => peerConnection.setLocalDescription(answer))
                    .then(() => {
                        // 发送Answer给共享者
                        socket.send(JSON.stringify({
                            type: 'answer',
                            answer: peerConnection.localDescription,
                            roomId: roomId
                        }));
                    });
            }

            // 共享者接收Answer
            if (message.type === 'answer' && isBroadcaster) {
                peerConnection.setRemoteDescription(new RTCSessionDescription(message.answer));
                statusText.textContent = '状态：观看者已连接，屏幕共享中';
            }

            // 接收ICE候选
            if (message.type === 'candidate') {
                peerConnection.addIceCandidate(new RTCIceCandidate(message.candidate))
                    .catch(err => console.error('添加ICE候选失败：', err));
            }
        });

        // 8. 停止共享核心函数
        function stopShare() {
            // 停止屏幕流
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }

            // 关闭WebRTC连接
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            // 重置UI
            screenPreview.srcObject = null;
            screenPreview.style.display = 'none';
            placeholder.style.display = 'block';
            startShareBtn.style.display = 'inline-block';
            stopShareBtn.style.display = 'none';

            if (isBroadcaster) {
                statusText.textContent = '状态：已停止屏幕共享';
                placeholder.innerHTML = '<p>点击「开始共享屏幕」，选择要共享的内容</p>';
            } else {
                statusText.textContent = '状态：共享已停止，等待共享者重新启动';
                placeholder.innerHTML = '<p>等待共享者启动屏幕共享...</p>';
            }
            statusText.style.color = '#666';
        }

        // 9. 页面关闭时清理
        window.addEventListener('beforeunload', () => {
            stopShare();
            socket.close();
        });

        // 10. 信令服务器状态监听
        socket.addEventListener('open', () => {
            console.log('信令服务器连接成功');
        });

        socket.addEventListener('close', () => {
            if (isBroadcaster && screenStream) {
                statusText.textContent = '状态：信令服务器断开，共享可能中断';
                statusText.style.color = '#dc3545';
            } else if (!isBroadcaster && screenPreview.srcObject) {
                statusText.textContent = '状态：信令服务器断开，观看已中断';
                statusText.style.color = '#dc3545';
            }
        });

        socket.addEventListener('error', (err) => {
            console.error('信令服务器错误：', err);
            statusText.textContent = '状态：信令服务器连接失败，请刷新页面';
            statusText.style.color = '#dc3545';
        });
    </script>
</body>
</html>
