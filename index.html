<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跨设备实时屏幕共享</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", Arial; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .btn-group { text-align: center; margin-bottom: 20px; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.3s;
        }
        #startBtn { background: #28a745; color: white; }
        #startBtn:hover { background: #218838; }
        #stopBtn { background: #dc3545; color: white; display: none; }
        #stopBtn:hover { background: #c82333; }
        .screen-box {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .tips { color: #999; text-align: center; font-size: 18px; }
        .status { text-align: center; margin-top: 15px; color: #666; font-size: 14px; }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
    </style>
    <!-- 修复：使用声网官方CDN（稳定且路径正确） -->
    <script src="https://download.agora.io/sdk/web/AgoraRTC_N-4.21.0.js"></script>
</head>
<body>
    <div class="container">
        <h1>跨设备实时屏幕共享</h1>
        <div class="btn-group">
            <button id="startBtn">开始共享屏幕</button>
            <button id="stopBtn">停止共享</button>
        </div>
        <div class="screen-box">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="tips" id="tips">等待共享者启动屏幕共享...</div>
        </div>
        <div class="status" id="status">状态：未开始共享</div>
    </div>

    <script>
        // ========== 配置（替换为你的App ID） ==========
        const AGORA_APP_ID = "8587d6296b864dd6934be1fae8ad0995"; // 替换为自己的App ID
        const CHANNEL_NAME = "screen-share-001"; // 固定频道名
        
        // ========== DOM元素 ==========
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const remoteVideo = document.getElementById('remoteVideo');
        const tips = document.getElementById('tips');
        const status = document.getElementById('status');
        
        // ========== 核心变量 ==========
        let agoraEngine = null; // Agora引擎实例
        let screenTrack = null; // 屏幕轨道
        let isSharing = false;  // 是否正在共享
        let localUid = null;    // 本地用户ID

        // ========== 初始化Agora引擎 ==========
        async function initAgoraEngine() {
            try {
                // 检查AgoraRTC是否加载成功
                if (typeof AgoraRTC === 'undefined') {
                    throw new Error("Agora SDK 加载失败，请检查网络或CDN链接");
                }

                // 创建引擎实例
                agoraEngine = AgoraRTC.createEngine();
                
                // 初始化引擎
                await agoraEngine.initialize({
                    appId: AGORA_APP_ID
                });
                
                // 监听远程用户发布流
                agoraEngine.on("user-published", async (evt) => {
                    const { user, mediaType } = evt;
                    // 避免订阅自己的流
                    if (user.uid === localUid) return;
                    
                    // 订阅远程用户的流
                    await agoraEngine.subscribe(user, mediaType);
                    
                    // 显示视频流
                    if (mediaType === "video") {
                        // 修复：新版SDK获取track的方式
                        const remoteVideoTrack = user.videoTrack;
                        remoteVideo.srcObject = new MediaStream([remoteVideoTrack.getTrack()]);
                        remoteVideo.style.display = "block";
                        tips.style.display = "none";
                        status.textContent = "状态：正在观看共享屏幕";
                        status.className = "status success";
                    }
                });

                // 监听远程用户取消发布
                agoraEngine.on("user-unpublished", (evt) => {
                    if (evt.user.uid === localUid) return;
                    remoteVideo.srcObject = null;
                    remoteVideo.style.display = "none";
                    tips.style.display = "block";
                    tips.textContent = "共享者已停止共享，等待重新开始...";
                    status.textContent = "状态：共享已停止";
                    status.className = "status";
                });

                // 监听用户离开频道
                agoraEngine.on("user-left", (evt) => {
                    if (evt.user.uid !== localUid) {
                        remoteVideo.srcObject = null;
                        remoteVideo.style.display = "none";
                        tips.style.display = "block";
                        tips.textContent = "共享者已离开频道，等待重新加入...";
                        status.textContent = "状态：共享者已离开";
                    }
                });

                // 生成随机UID并加入频道
                localUid = Math.floor(Math.random() * 1000000);
                await agoraEngine.joinChannel({
                    channelId: CHANNEL_NAME,
                    uid: localUid,
                    role: "audience" // 默认以观众身份加入
                });
                
                status.textContent = "状态：已连接到共享频道，等待共享者启动";
                return true;

            } catch (error) {
                console.error("Agora初始化失败：", error);
                status.textContent = `状态：初始化失败 - ${error.message}`;
                status.className = "status error";
                return false;
            }
        }

        // ========== 开始共享屏幕 ==========
        async function startScreenShare() {
            try {
                // 禁用按钮防止重复点击
                startBtn.disabled = true;
                status.textContent = "状态：正在请求屏幕共享权限...";

                // 切换为主播角色（必须在发布前切换）
                await agoraEngine.setClientRole({ role: "host" });

                // 捕获屏幕流（兼容不同浏览器）
                screenTrack = await AgoraRTC.createScreenVideoTrack({
                    encoderConfig: { 
                        width: { ideal: 1920, max: 1920 }, 
                        height: { ideal: 1080, max: 1080 },
                        frameRate: 30 
                    },
                    cursor: "always", // 始终显示鼠标
                    optimizationMode: "motion" // 针对动态内容优化
                });

                // 监听屏幕共享被手动停止（比如用户关闭共享窗口）
                screenTrack.on("ended", async () => {
                    await stopScreenShare();
                    status.textContent = "状态：屏幕共享被手动终止";
                });

                // 发布屏幕流
                await agoraEngine.publish([screenTrack]);

                // 本地预览自己的屏幕
                remoteVideo.srcObject = new MediaStream([screenTrack.getTrack()]);
                remoteVideo.style.display = "block";
                tips.style.display = "none";

                // 更新UI
                isSharing = true;
                startBtn.style.display = "none";
                stopBtn.style.display = "inline-block";
                status.textContent = "状态：屏幕共享中，其他设备可加入观看";
                status.className = "status success";
                startBtn.disabled = false;

            } catch (error) {
                console.error("共享启动失败：", error);
                status.textContent = `状态：共享失败 - ${error.message}`;
                status.className = "status error";
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                startBtn.disabled = false;
                // 失败后切回观众角色
                await agoraEngine.setClientRole({ role: "audience" });
            }
        }

        // ========== 停止共享屏幕 ==========
        async function stopScreenShare() {
            try {
                if (!isSharing) return;

                // 停止并销毁屏幕轨道
                if (screenTrack) {
                    screenTrack.stop();
                    screenTrack.close();
                    await agoraEngine.unpublish([screenTrack]);
                    screenTrack = null;
                }

                // 切换回观众角色
                await agoraEngine.setClientRole({ role: "audience" });

                // 更新UI
                isSharing = false;
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                remoteVideo.srcObject = null;
                remoteVideo.style.display = "none";
                tips.style.display = "block";
                tips.textContent = "等待共享者启动屏幕共享...";
                status.textContent = "状态：已停止共享";
                status.className = "status";

            } catch (error) {
                console.error("停止共享失败：", error);
                status.textContent = `状态：停止失败 - ${error.message}`;
                status.className = "status error";
            }
        }

        // ========== 页面初始化与事件监听 ==========
        window.addEventListener("DOMContentLoaded", async () => {
            // 初始化引擎
            const initSuccess = await initAgoraEngine();
            if (initSuccess) {
                // 绑定按钮事件
                startBtn.addEventListener("click", startScreenShare);
                stopBtn.addEventListener("click", stopScreenShare);
            }
        });

        // ========== 页面关闭/刷新时清理资源 ==========
        window.addEventListener("beforeunload", async () => {
            try {
                if (isSharing) await stopScreenShare();
                if (agoraEngine) {
                    await agoraEngine.leaveChannel();
                    agoraEngine.release(); // 释放引擎资源
                }
            } catch (e) {
                console.warn("清理资源时出错：", e);
            }
        });
    </script>
</body>
</html>
