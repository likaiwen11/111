<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跨设备实时屏幕共享</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei", Arial; }
        body { background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        .btn-group { text-align: center; margin-bottom: 20px; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 8px;
            transition: all 0.3s;
        }
        #startBtn { background: #28a745; color: white; }
        #startBtn:hover { background: #218838; }
        #stopBtn { background: #dc3545; color: white; display: none; }
        #stopBtn:hover { background: #c82333; }
        .screen-box {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }
        .tips { color: #999; text-align: center; font-size: 18px; }
        .status { text-align: center; margin-top: 15px; color: #666; font-size: 14px; }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
    </style>
    <!-- 引入Agora RTC SDK（免费） -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.21.0.js"></script>
</head>
<body>
    <div class="container">
        <h1>跨设备实时屏幕共享</h1>
        <div class="btn-group">
            <button id="startBtn">开始共享屏幕</button>
            <button id="stopBtn">停止共享</button>
        </div>
        <div class="screen-box">
            <video id="remoteVideo" autoplay playsinline></video>
            <div class="tips" id="tips">等待共享者启动屏幕共享...</div>
        </div>
        <div class="status" id="status">状态：未开始共享</div>
    </div>

    <script>
        // ========== 配置（替换为你的App ID） ==========
        const AGORA_APP_ID = "8587d6296b864dd6934be1fae8ad0995"; // 替换成你自己的Agora App ID
        const CHANNEL_NAME = "screen-share-001"; // 固定频道名，所有人进同一个频道
        
        // ========== DOM元素 ==========
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const remoteVideo = document.getElementById('remoteVideo');
        const tips = document.getElementById('tips');
        const status = document.getElementById('status');
        
        // ========== 核心变量 ==========
        let agoraClient = null; // Agora客户端实例
        let screenTrack = null; // 屏幕轨道
        let isSharing = false;  // 是否正在共享

        // ========== 初始化Agora客户端 ==========
        async function initAgoraClient() {
            try {
                // 创建客户端实例（直播模式：主播-观众）
                agoraClient = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
                
                // 初始化客户端
                await agoraClient.init(AGORA_APP_ID);
                
                // 监听远程用户加入（观看者接收共享流）
                agoraClient.on("user-published", async (user, mediaType) => {
                    // 订阅远程用户的流
                    await agoraClient.subscribe(user, mediaType);
                    
                    // 当订阅到视频流时，显示画面
                    if (mediaType === "video") {
                        remoteVideo.srcObject = user.videoTrack.playbackTrack.mediaStream;
                        remoteVideo.style.display = "block";
                        tips.style.display = "none";
                        status.textContent = "状态：正在观看共享屏幕";
                        status.className = "status success";
                    }
                });

                // 监听远程用户离开
                agoraClient.on("user-unpublished", () => {
                    remoteVideo.srcObject = null;
                    remoteVideo.style.display = "none";
                    tips.style.display = "block";
                    tips.textContent = "共享者已停止共享，等待重新开始...";
                    status.textContent = "状态：共享已停止";
                    status.className = "status";
                });

                // 加入频道（所有人加入同一个频道）
                // 生成随机UID（无需登录，测试用）
                const uid = Math.floor(Math.random() * 1000000);
                await agoraClient.join(AGORA_APP_ID, CHANNEL_NAME, null, uid);
                
                status.textContent = "状态：已连接到共享频道，等待共享者启动";
                return true;

            } catch (error) {
                console.error("Agora初始化失败：", error);
                status.textContent = `状态：初始化失败 - ${error.message}`;
                status.className = "status error";
                return false;
            }
        }

        // ========== 开始共享屏幕 ==========
        async function startScreenShare() {
            try {
                // 1. 捕获屏幕流
                screenTrack = await AgoraRTC.createScreenVideoTrack({
                    encoderConfig: {
                        width: 1920,
                        height: 1080,
                        frameRate: 30
                    },
                    cursor: "always" // 显示鼠标光标
                });

                // 2. 设置为主播角色（只有主播能发布流）
                await agoraClient.setClientRole("host");

                // 3. 发布屏幕流到频道
                await agoraClient.publish([screenTrack]);

                // 4. 本地预览（共享者自己也能看到）
                remoteVideo.srcObject = screenTrack.playbackTrack.mediaStream;
                remoteVideo.style.display = "block";
                tips.style.display = "none";

                // 5. 更新UI和状态
                isSharing = true;
                startBtn.style.display = "none";
                stopBtn.style.display = "inline-block";
                status.textContent = "状态：屏幕共享中，其他人可实时观看";
                status.className = "status success";

                // 监听屏幕流结束（用户手动停止共享）
                screenTrack.on("ended", stopScreenShare);

            } catch (error) {
                console.error("共享启动失败：", error);
                status.textContent = `状态：共享失败 - ${error.message}`;
                status.className = "status error";
                // 恢复初始状态
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
            }
        }

        // ========== 停止共享屏幕 ==========
        async function stopScreenShare() {
            try {
                if (screenTrack) {
                    // 停止屏幕轨道
                    screenTrack.stop();
                    // 取消发布
                    await agoraClient.unpublish([screenTrack]);
                    screenTrack = null;
                }

                // 恢复为观众角色
                await agoraClient.setClientRole("audience");

                // 更新UI和状态
                isSharing = false;
                startBtn.style.display = "inline-block";
                stopBtn.style.display = "none";
                remoteVideo.srcObject = null;
                remoteVideo.style.display = "none";
                tips.style.display = "block";
                tips.textContent = "等待共享者启动屏幕共享...";
                status.textContent = "状态：已停止共享";
                status.className = "status";

            } catch (error) {
                console.error("停止共享失败：", error);
                status.textContent = `状态：停止失败 - ${error.message}`;
                status.className = "status error";
            }
        }

        // ========== 事件监听 ==========
        // 页面加载完成后初始化
        window.addEventListener("load", async () => {
            const initSuccess = await initAgoraClient();
            if (initSuccess) {
                // 只有初始化成功后，才绑定开始按钮事件
                startBtn.addEventListener("click", startScreenShare);
                stopBtn.addEventListener("click", stopScreenShare);
            }
        });

        // 页面关闭时清理
        window.addEventListener("beforeunload", async () => {
            if (isSharing) {
                await stopScreenShare();
            }
            if (agoraClient) {
                await agoraClient.leave();
                agoraClient = null;
            }
        });
    </script>
</body>
</html>
